% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/combined_line_plot.R
\name{create_combined_sunflower_plot}
\alias{create_combined_sunflower_plot}
\title{Create Combined Sunflower and Marginal Effects Plot}
\usage{
create_combined_sunflower_plot(
  plot_data,
  predictions = NULL,
  me_data = NULL,
  main_title,
  subtitle = NULL,
  caption = NULL,
  moderator = "vote_trump",
  moderator_levels = c(0, 1),
  group_labels = c("Group 0", "Group 1"),
  category_var = "category",
  category_levels = c("1", "2", "3", "4", "5"),
  category_labels = c("Strongly Disagree", "Disagree", "Neither Agree nor Disagree",
    "Agree", "Strongly Agree"),
  x_var = "prepost",
  join_vars = c("prepost", "category"),
  focal_var = "prepost",
  focal_contrast = c(0, 1),
  colors = c(`1` = "lightgrey", `2` = "grey", `3` = "darkgrey", `4` = "darkslategrey",
    `5` = "black"),
  me_y_var = "mean_effect",
  me_x_var = "category",
  me_ci_lower = NULL,
  me_ci_upper = NULL,
  sunflower_params = list(sunflower_size = 0.2, sunflower_alpha = 0.25, errorbar_width =
    0.1, errorbar_linewidth = 0.8, line_linewidth = 1, dodge_width = 0.5,
    sunflower_density = 50, sunflower_aspect_ratio = 5, y_limits = c(0, 0.5), y_breaks =
    seq(0, 0.5, 0.1)),
  marginal_params = list(point_size = 3, point_alpha = 0.8, connector_lines = FALSE,
    show_errorbar = TRUE, errorbar_width = 0.2, reference_line = 0, y_limits = c(-0.3,
    0.3), dodge_width = 0.6),
  layout_widths = c(0.9, 1),
  layout_heights = c(1, 1),
  save_path = NULL,
  width = 8,
  height = 6
)
}
\arguments{
\item{plot_data}{A list containing two elements:
\describe{
  \item{plotting_data}{Data frame with prediction summaries (mean_prob, lower_ci, upper_ci)}
  \item{observed_counts}{Data frame with observed counts (n) for each category combination}
}}

\item{predictions}{Predictions object (long format) for calculating marginal effects.
Optional if me_data is provided. Must contain 'draw' column.}

\item{me_data}{Pre-calculated marginal effects data frame. Optional, overrides predictions.
Should contain mean_effect, lower_ci, upper_ci columns.}

\item{main_title}{Character. Main title for the combined plot.}

\item{subtitle}{Character. Subtitle for the combined plot. Default: NULL}

\item{caption}{Character. Caption/notes for the combined plot. Default: NULL}

\item{moderator}{Character. Name of the moderator variable (as string).
This variable defines the two groups to compare. Default: "vote_trump"}

\item{moderator_levels}{Vector of length 2. Values of moderator variable indicating
which levels to plot. Default: c(0, 1)}

\item{group_labels}{Character vector of length 2. Labels for each group/panel.
Default: c("Group 0", "Group 1")}

\item{category_var}{Character. Name of the category variable. Default: "category"}

\item{category_levels}{Character vector. Underlying levels of category variable
(as they appear in data). Default: c("1", "2", "3", "4", "5")}

\item{category_labels}{Character vector. Display labels for categories.
Default: c("Strongly Disagree", "Disagree", "Neither Agree nor Disagree",
           "Agree", "Strongly Agree")}

\item{x_var}{Character. Name of the x-axis variable with labels (e.g., "prepost" or
"prepost_label"). Default: "prepost"}

\item{join_vars}{Character vector. Variable names to use for joining pred_summary
and observed_counts. Must include all grouping variables.
Default: c("prepost", "category")}

\item{focal_var}{Character. Focal variable for marginal effects calculation.
Default: "prepost"}

\item{focal_contrast}{Vector of length 2. Values of focal_var to contrast when
calculating marginal effects. Effect = focal_contrast[2] - focal_contrast[1].
Default: c(0, 1)}

\item{colors}{Named vector. Colors for each category level. Names should match
category_levels. Default: c("1" = "lightgrey", "2" = "grey", "3" = "darkgrey",
                             "4" = "darkslategrey", "5" = "black")}

\item{me_y_var}{Character. Name of y variable in marginal effects data.
Default: "mean_effect"}

\item{me_x_var}{Character. Name of x variable in marginal effects data.
Default: "category"}

\item{me_ci_lower}{Character. Name of lower CI column in marginal effects.
Default: NULL (auto-detects "lower_ci" or "lower")}

\item{me_ci_upper}{Character. Name of upper CI column in marginal effects.
Default: NULL (auto-detects "upper_ci" or "upper")}

\item{sunflower_params}{List. Parameters for sunflower plots passed to plotSunflower.
Default list includes:
\describe{
  \item{sunflower_size}{Size of sunflower points (default: 0.2)}
  \item{sunflower_alpha}{Transparency of sunflower points (default: 0.25)}
  \item{errorbar_width}{Width of error bars (default: 0.1)}
  \item{errorbar_linewidth}{Line width of error bars (default: 0.8)}
  \item{line_linewidth}{Line width for connecting lines (default: 1)}
  \item{dodge_width}{Dodging width for position adjustment (default: 0.5)}
  \item{sunflower_density}{Density parameter for sunflower positioning (default: 50)}
  \item{sunflower_aspect_ratio}{Aspect ratio for sunflower positioning (default: 5)}
  \item{y_limits}{Y-axis limits as numeric vector (default: c(0, 0.5))}
  \item{y_breaks}{Y-axis break points (default: seq(0, 0.5, 0.1))}
}}

\item{marginal_params}{List. Parameters for marginal effect plots passed to plotDots.
Default list includes:
\describe{
  \item{point_size}{Size of effect estimate points (default: 3)}
  \item{point_alpha}{Transparency of points (default: 0.8)}
  \item{connector_lines}{Whether to draw connector lines (default: FALSE)}
  \item{show_errorbar}{Whether to show error bars (default: TRUE)}
  \item{errorbar_width}{Width of error bars (default: 0.2)}
  \item{reference_line}{Y-value for reference line (default: 0)}
  \item{y_limits}{Y-axis limits (default: c(-0.3, 0.3))}
  \item{dodge_width}{Dodging width (default: 0.6)}
}}

\item{layout_widths}{Numeric vector of length 2. Width ratios for patchwork layout.
Default: c(0.9, 1)}

\item{layout_heights}{Numeric vector of length 2. Height ratios for patchwork layout.
Default: c(1, 1)}

\item{save_path}{Character. Optional file path to save the plot. Default: NULL}

\item{width}{Numeric. Plot width in inches for saving. Default: 8}

\item{height}{Numeric. Plot height in inches for saving. Default: 6}
}
\value{
A patchwork object containing the combined 2x2 plot. Can be further
  customized using patchwork operators or displayed directly.
}
\description{
Creates a 2x2 panel plot with sunflower plots (using plotSunflower) showing
predicted probabilities with error bars and connecting lines, plus marginal
effects plots for two groups defined by a moderator variable. Left panels show
predicted probabilities with sunflower distributions, right panels show marginal
effects with confidence intervals.
}
\details{
This function creates a 2x2 panel layout comparing two groups:
\itemize{
  \item Top-left: Sunflower plot for group 1 (no legend)
  \item Top-right: Marginal effects for group 1
  \item Bottom-left: Sunflower plot for group 2 (with legend)
  \item Bottom-right: Marginal effects for group 2
}

The sunflower plots show predicted probabilities with connecting lines between
conditions (e.g., pre to post), error bars for uncertainty, and sunflower points
showing the distribution of observed responses. The marginal effects panels show
the difference in predicted probabilities between conditions with confidence intervals.
}
\examples{
\dontrun{
# Fit ordered logistic regression model
library(MASS)
model <- polr(outcome ~ prepost * vote_trump + age + education,
              data = survey_data, method = "logistic", Hess = TRUE)

# Generate predictions
design <- expand.grid(
  prepost = c(0, 1),
  vote_trump = c(0, 1),
  age = mean(survey_data$age),
  education = mean(survey_data$education)
)

predictions <- predict_ordinal_probs(
  design_matrix = design,
  model = model,
  n_draws = 1000,
  category_labels = c("1", "2", "3", "4", "5")
)

# Prepare plot data
plot_data <- prepare_prediction_data(
  data = survey_data,
  predictions = predictions,
  category_var = "outcome",
  group_vars = c("prepost", "vote_trump")
)

# Basic usage
create_combined_sunflower(
  plot_data = plot_data,
  predictions = predictions,
  main_title = "Policy Support Analysis",
  subtitle = "Pre vs Post Treatment by Voter Group",
  moderator = "vote_trump",
  moderator_levels = c(0, 1),
  group_labels = c("Biden Voters", "Trump Voters")
)

# With custom styling
create_combined_sunflower(
  plot_data = plot_data,
  predictions = predictions,
  main_title = "Policy Support (Custom)",
  group_labels = c("Biden Voters", "Trump Voters"),
  sunflower_params = list(
    sunflower_size = 0.3,
    sunflower_alpha = 0.4,
    line_linewidth = 1.5,
    y_limits = c(0, 0.6)
  ),
  marginal_params = list(
    point_size = 4,
    errorbar_width = 0.3,
    y_limits = c(-0.4, 0.4)
  )
)

# Save to file
create_combined_sunflower(
  plot_data = plot_data,
  predictions = predictions,
  main_title = "Policy Support Analysis",
  group_labels = c("Biden Voters", "Trump Voters"),
  save_path = "policy_support.png",
  width = 10,
  height = 7
)
}

}
\seealso{
\code{\link{plotSunflower}} for the individual sunflower plots,
\code{\link{plotDots}} for the marginal effects plots,
\code{\link{calculate_marginal_effect}} for computing marginal effects,
\code{\link{prepare_prediction_data}} for preparing input data
}
